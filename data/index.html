<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32 Generic IO</title>
    <style>
        :root { --primary-color: #4a69bd; --secondary-color: #6a89cc; --light-gray: #f5f6fa; --dark-gray: #576574; --success-color: #2ecc71; --error-color: #e74c3c; --off-color: #c8d6e5; --on-color: #feca57; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: var(--light-gray); color: var(--dark-gray); margin: 20px; }
        .container { max-width: 1000px; margin: 0 auto; background: white; border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); overflow: hidden; }
        .header { background: var(--primary-color); color: white; padding: 25px; text-align: center; }
        .tabs { display: flex; background: #fff; border-bottom: 1px solid #eee; }
        .tab { flex: 1; padding: 15px; text-align: center; cursor: pointer; background: #fff; border: none; font-size: 16px; transition: all 0.3s; color: var(--dark-gray); border-bottom: 3px solid transparent; }
        .tab.active { color: var(--primary-color); border-bottom: 3px solid var(--primary-color); font-weight: bold; }
        .content { padding: 30px; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        h2 { margin-bottom: 20px; color: var(--primary-color); border-bottom: 2px solid var(--light-gray); padding-bottom: 10px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; }
        .card { background: #fff; border-radius: 10px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .status-item, .io-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #eee; }
        .badge { padding: 5px 12px; border-radius: 15px; font-size: 13px; font-weight: bold; color: white; }
        .badge-success { background: var(--success-color); }
        .badge-danger { background: var(--error-color); }
        .status-indicator { display: inline-block; width: 20px; height: 20px; border-radius: 50%; margin-left: 10px; }
        .status-inactive { background-color: #95a5a6; }
        .status-active { background-color: var(--success-color); box-shadow: 0 0 10px rgba(46, 204, 113, 0.5); }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: bold; }
        .form-group input, .form-group select { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; font-size: 16px; }
        .btn { padding: 12px 20px; font-size: 16px; border: none; border-radius: 8px; cursor: pointer; transition: all 0.3s; color: white; font-weight: bold; }
        .btn-primary { background-color: var(--primary-color); }
        .btn-danger { background-color: var(--error-color); }
        .btn-small { padding: 8px 12px; font-size: 14px; }
        .toggle-switch { position: relative; display: inline-block; width: 60px; height: 34px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--off-color); transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--on-color); }
        input:checked + .slider:before { transform: translateX(26px); }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: var(--light-gray); }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>ESP32 Generic IO</h1>
        <p>Contr√¥leur d'I/O avec interface Web et MQTT</p>
    </div>
    <div class="tabs">
        <button class="tab active" onclick="switchTab(event, 'status')">Statut & Contr√¥le</button>
        <button class="tab" onclick="switchTab(event, 'ios')">Configuration I/O</button>
        <button class="tab" onclick="switchTab(event, 'config')">Configuration Syst√®me</button>
        <button class="tab" onclick="switchTab(event, 'network')">R√©seau</button>
        <button class="tab" onclick="switchTab(event, 'update')">Mise √† Jour</button>
    </div>
    <div class="content">
        <!-- TAB STATUT & CONTROLE -->
        <div id="status" class="tab-content active">
            <h2>Statut du Syst√®me</h2>
            <div class="grid">
                <div class="card">
                    <div class="status-item"><span>Nom de l'appareil</span><span id="device-name">...</span></div>
                    <div class="status-item"><span>WiFi</span><span id="wifi-status">...</span></div>
                    <div class="status-item"><span>Adresse IP</span><span id="ip-address">...</span></div>
                    <div class="status-item"><span>MQTT</span><span id="mqtt-status">...</span></div>
                    <div class="status-item"><span>Heure Locale</span><span id="local-time">...</span></div>
                </div>
            </div>
            <h2 style="margin-top: 30px;">Contr√¥le des Sorties</h2>
            <div class="grid" id="outputs-control"><p>Aucune sortie configur√©e.</p></div>
            <h2 style="margin-top: 30px;">√âtat des Entr√©es</h2>
            <div class="grid" id="inputs-status"><p>Aucune entr√©e configur√©e.</p></div>
        </div>
        <!-- TAB CONFIG I/O -->
        <div id="ios" class="tab-content">
            <h2>Configuration des I/O</h2>
            <table id="ios-table">
                <thead><tr><th>Nom</th><th>Pin</th><th>Mode</th><th>D√©faut</th><th>Action</th></tr></thead>
                <tbody id="ios-tbody"></tbody>
            </table>
            <div class="card" style="margin-top: 20px;">
                <h3>Ajouter un I/O</h3>
                <div class="form-group"><label for="io-name">Nom</label><input type="text" id="io-name" placeholder="Ex: Lumi√®re Salon"></div>
                <div class="form-group"><label for="io-pin">Broche (Pin)</label><input type="number" id="io-pin" placeholder="Ex: 23"></div>
                <div class="form-group"><label for="io-mode">Mode</label><select id="io-mode"><option value="1">Entr√©e (INPUT)</option><option value="2">Sortie (OUTPUT)</option></select></div>
                <div class="form-group"><label for="io-default-state">√âtat par d√©faut (pour sorties)</label><select id="io-default-state"><option value="0">BAS (OFF)</option><option value="1">HAUT (ON)</option></select></div>
                <button class="btn btn-primary" onclick="addIO()">Ajouter I/O</button>
            </div>
            <button class="btn btn-primary" style="margin-top: 20px;" onclick="saveIOs()">üíæ Enregistrer la Configuration I/O</button>
        </div>
        <!-- TAB CONFIG MQTT -->
        <div id="config" class="tab-content">
            <h2>Configuration MQTT & Syst√®me</h2>
            <div class="card">
                <div class="form-group"><label>Nom de l'appareil</label><input type="text" id="config-device-name"></div>
                <div class="form-group"><label>Serveur MQTT</label><input type="text" id="mqtt-server"></div>
                <div class="form-group"><label>Port</label><input type="number" id="mqtt-port" value="1883"></div>
                <div class="form-group"><label>Utilisateur</label><input type="text" id="mqtt-user"></div>
                <div class="form-group"><label>Mot de passe</label><input type="password" id="mqtt-password" placeholder="Laisser vide pour ne pas changer"></div>
                <button class="btn btn-primary" onclick="saveConfig()">üíæ Enregistrer & Red√©marrer</button>
            </div>
            <h2 style="margin-top: 30px;">Contr√¥le de la Connexion</h2>
            <div class="card">
                <p>G√©rer manuellement la connexion au serveur MQTT.</p>
                <div style="display: flex; gap: 10px; margin-top: 10px;">
                    <button class="btn btn-primary" onclick="connectMQTT()">Connecter</button>
                    <button class="btn btn-danger" onclick="disconnectMQTT()">D√©connecter</button>
                </div>
            </div>
        </div>
        <!-- TAB NETWORK -->
        <div id="network" class="tab-content">
            <h2>Configuration R√©seau</h2>
            <div class="card">
                <div class="form-group">
                    <label>Type d'adressage</label>
                    <select id="ip-type" onchange="toggleStaticFields()">
                        <option value="dhcp">DHCP (Automatique)</option>
                        <option value="static">IP Statique (Manuel)</option>
                    </select>
                </div>
                <div id="static-ip-fields" style="display:none;">
                    <div class="form-group"><label>Adresse IP</label><input type="text" id="static-ip"></div>
                    <div class="form-group"><label>Passerelle (Gateway)</label><input type="text" id="static-gateway"></div>
                    <div class="form-group"><label>Masque de sous-r√©seau</label><input type="text" id="static-subnet"></div>
                </div>
                <button class="btn btn-primary" onclick="saveConfig()">üíæ Enregistrer & Red√©marrer</button>
            </div>
        </div>
        <!-- TAB UPDATE -->
        <div id="update" class="tab-content">
            <h2>Mise √† Jour Firmware (OTA)</h2>
            <div class="card">
                <p>Utilisez cette page pour t√©l√©verser un nouveau firmware (.bin) sur l'appareil.</p>
                <a href="/update" target="_blank"><button class="btn btn-primary" style="margin-top: 20px;">üì° Ouvrir l'Interface de Mise √† Jour</button></a>
            </div>
        </div>
    </div>
</div>
<script>
    let ioPins = [];

    function switchTab(evt, tabName) {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.getElementById(tabName).classList.add('active');
        evt.currentTarget.classList.add('active');
        if (tabName === 'status') loadStatus();
        if (tabName === 'ios') loadIOs();
        if (tabName === 'config' || tabName === 'network') loadConfig();
    }

    function toggleStaticFields() {
        const ipType = document.getElementById('ip-type').value;
        document.getElementById('static-ip-fields').style.display = (ipType === 'static') ? 'block' : 'none';
    }

    function loadStatus() {
        fetch('/api/status').then(r => r.json()).then(data => {
            document.getElementById('device-name').textContent = data.deviceName;
            document.getElementById('wifi-status').innerHTML = data.wifi ? '<span class="badge badge-success">Connect√©</span>' : '<span class="badge badge-danger">D√©connect√©</span>';
            document.getElementById('ip-address').textContent = data.ip;
            document.getElementById('mqtt-status').innerHTML = data.mqtt ? '<span class="badge badge-success">Connect√©</span>' : '<span class="badge badge-danger">D√©connect√©</span>';
            document.getElementById('local-time').textContent = data.time;
            
            const outputsDiv = document.getElementById('outputs-control');
            const inputsDiv = document.getElementById('inputs-status');
            outputsDiv.innerHTML = '';
            inputsDiv.innerHTML = '';

            const outputs = data.ios.filter(io => io.mode == 2);
            const inputs = data.ios.filter(io => io.mode == 1);

            if (outputs.length > 0) {
                outputs.forEach(io => {
                    outputsDiv.innerHTML += `<div class="card io-item"><span>${io.name} (GPIO ${io.pin})</span><label class="toggle-switch"><input type="checkbox" ${io.state ? 'checked' : ''} onchange="setIO('${io.name}', this.checked)"><span class="slider"></span></label></div>`;
                });
            } else {
                outputsDiv.innerHTML = '<p>Aucune sortie configur√©e.</p>';
            }

            if (inputs.length > 0) {
                inputs.forEach(io => {
                    const statusClass = io.state ? 'status-active' : 'status-inactive';
                    const statusText = io.state ? 'HAUT' : 'BAS';
                    inputsDiv.innerHTML += `<div class="card io-item"><span>${io.name} (GPIO ${io.pin})</span><span>${statusText}<span class="status-indicator ${statusClass}"></span></span></div>`;
                });
            } else {
                inputsDiv.innerHTML = '<p>Aucune entr√©e configur√©e.</p>';
            }
        });
    }

    function setIO(name, state) {
        fetch('/api/io/set', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ name: name, state: state })
        }).then(r => r.json()).then(data => {
            console.log(data.message);
            setTimeout(loadStatus, 250);
        });
    }

    function loadIOs() {
        fetch('/api/ios').then(r => r.json()).then(data => {
            ioPins = data.ios || [];
            renderIOTable();
        });
    }

    function renderIOTable() {
        const tbody = document.getElementById('ios-tbody');
        tbody.innerHTML = '';
        ioPins.forEach((io, index) => {
            tbody.innerHTML += `<tr><td>${io.name}</td><td>${io.pin}</td><td>${io.mode == 1 ? 'Entr√©e' : 'Sortie'}</td><td>${io.defaultState ? 'HAUT' : 'BAS'}</td><td><button class="btn btn-danger btn-small" onclick="deleteIO(${index})">X</button></td></tr>`;
        });
    }

    function addIO() {
        const name = document.getElementById('io-name').value;
        const pin = parseInt(document.getElementById('io-pin').value);
        const mode = parseInt(document.getElementById('io-mode').value);
        const defaultState = parseInt(document.getElementById('io-default-state').value);
        if (!name || isNaN(pin)) {
            alert("Le nom et la broche sont requis.");
            return;
        }
        ioPins.push({ name, pin, mode, defaultState, state: false });
        renderIOTable();
        document.getElementById('io-name').value = '';
        document.getElementById('io-pin').value = '';
    }

    function deleteIO(index) {
        if (confirm(`Voulez-vous vraiment supprimer l'I/O "${ioPins[index].name}" ?`)) {
            ioPins.splice(index, 1);
            renderIOTable();
        }
    }

    function saveIOs() {
        fetch('/api/ios', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ ios: ioPins })
        }).then(r => r.json()).then(data => {
            alert(data.message || "Erreur lors de la sauvegarde.");
            if(data.success) loadIOs();
        });
    }

    function loadConfig() {
        fetch('/api/config').then(r => r.json()).then(data => {
            document.getElementById('config-device-name').value = data.deviceName;
            document.getElementById('mqtt-server').value = data.mqttServer;
            document.getElementById('mqtt-port').value = data.mqttPort;
            document.getElementById('mqtt-user').value = data.mqttUser;

            document.getElementById('ip-type').value = data.useStaticIP ? 'static' : 'dhcp';
            document.getElementById('static-ip').value = data.staticIP;
            document.getElementById('static-gateway').value = data.staticGateway;
            document.getElementById('static-subnet').value = data.staticSubnet;
            toggleStaticFields();
        });
    }

    function saveConfig() {
        const config = {
            deviceName: document.getElementById('config-device-name').value,
            mqttServer: document.getElementById('mqtt-server').value,
            mqttPort: parseInt(document.getElementById('mqtt-port').value),
            mqttUser: document.getElementById('mqtt-user').value,
            mqttPassword: document.getElementById('mqtt-password').value,
            useStaticIP: document.getElementById('ip-type').value === 'static',
            staticIP: document.getElementById('static-ip').value,
            staticGateway: document.getElementById('static-gateway').value,
            staticSubnet: document.getElementById('static-subnet').value
        };
        fetch('/api/config', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(config)
        }).then(r => r.json()).then(data => {
            alert(data.message || 'Erreur');
            if(data.success) {
                setTimeout(() => alert("L'appareil va red√©marrer."), 500);
            }
        });
    }

    function connectMQTT() {
        fetch('/api/mqtt/connect', { method: 'POST' })
            .then(r => r.json())
            .then(data => {
                alert(data.message);
                loadStatus();
            });
    }

    function disconnectMQTT() {
        fetch('/api/mqtt/disconnect', { method: 'POST' })
            .then(r => r.json())
            .then(data => {
                alert(data.message);
                loadStatus();
            });
    }

    window.onload = () => {
        loadStatus();
        setInterval(loadStatus, 5000);
    };
</script>
</body>
</html>